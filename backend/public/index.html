<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Chat GPT-4.1 RAG</title>
  <style>
    body { font-family: Arial, sans-serif; background: #f7f7f7; display: flex; flex-direction: column; align-items: center; margin: 0; padding: 1rem; height: 100vh; box-sizing: border-box; }
    h1   { margin: 0 0 1rem; color: #333; }
    #chat { background: #fff; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); padding: 1rem; width: 100%; max-width: 600px; flex: 1; overflow-y: auto; margin-bottom: 1rem; box-sizing: border-box; }
    .message { margin: 0.5rem 0; padding: 0.75rem; border-radius: 12px; line-height: 1.4; max-width: 80%; word-wrap: break-word; }
    .user    { background: #007bff; color: #fff; align-self: flex-end; margin-left: auto; }
    .bot     { background: #e9ecef; color: #333; align-self: flex-start; margin-right: auto; }
    .typing  { font-style: italic; opacity: 0.7; }
    #controls { display: flex; width: 100%; max-width: 600px; gap: 0.5rem; box-sizing: border-box; }
    textarea { flex: 1; padding: 0.75rem; border-radius: 8px; border: 1px solid #ccc; font-size: 1rem; resize: vertical; min-height: 50px; max-height: 150px; box-sizing: border-box; }
    button   { padding: 0.75rem 1rem; border: none; border-radius: 8px; background: #28a745; color: #fff; font-size: 1rem; cursor: pointer; transition: background 0.2s; white-space: nowrap; }
    button:hover { background: #218838; }
    button.active { background: #dc3545; }
    pre      { background: #f1f1f1; border-radius: 8px; padding: 1rem; overflow-x: auto; font-family: monospace; margin-top: 1rem; white-space: pre-wrap; position: relative; }
    code     { background: #eee; padding: 2px 4px; border-radius: 4px; }
    h3       { margin-top: 1rem; }
    .code-block { position: relative; }
    .copy-btn { position: absolute; top: 0.5rem; right: 0.5rem; background: #6c757d; color: white; border: none; border-radius: 4px; padding: 0.3rem 0.5rem; font-size: 0.8rem; cursor: pointer; opacity: 0.8; }
    .copy-btn:hover { opacity: 1; }
    #file-tree { width: 100%; max-width: 600px; margin-top: 1rem; display: none; box-sizing: border-box; }
    img.chat-image { max-width: 100%; max-height: 300px; border-radius: 8px; margin: 0.5rem 0; }
    .image-preview { display: none; max-width: 100%; margin-top: 0.5rem; }
    .image-preview img { max-width: 100%; max-height: 200px; border-radius: 5px; }
    .image-preview button { margin-top: 0.5rem; background: #dc3545; }
    .paste-info { color: #6c757d; font-size: 0.8rem; margin-top: 0.25rem; }
    .clear-btn { background: #6c757d; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>
<body>
  <h1>Chat GPT-4.1 RAG</h1>
  <div id="chat"></div>
  <div id="controls">
    <textarea id="input" placeholder="Écris ton message... (Entrée = envoyer, Maj+Entrée = saut de ligne)" autocomplete="off"></textarea>
    <button id="send">Envoyer</button>
    <button id="clear" class="clear-btn">Effacer</button>
  </div>
  <div id="image-preview" class="image-preview">
    <img id="preview-img" src="" alt="Aperçu de l'image">
    <button id="remove-image">Supprimer l'image</button>
  </div>
  <div class="paste-info">Coller une image (Ctrl+V) pour l'intégrer à votre message</div>
  <button id="show-tree">Afficher arbre</button>
  <pre id="file-tree"></pre>
  <script>
    const chatEl = document.getElementById('chat');
    const inputEl = document.getElementById('input');
    const sendBtn = document.getElementById('send');
    const clearBtn = document.getElementById('clear');
    const showTreeBtn = document.getElementById('show-tree');
    const fileTreeEl = document.getElementById('file-tree');
    const imagePreviewEl = document.getElementById('image-preview');
    const previewImgEl = document.getElementById('preview-img');
    const removeImgBtn = document.getElementById('remove-image');
    
    let history = [];
    let treeVisible = false;
    let currentImageData = null;
    
    // Chargement de l'historique de conversation depuis le localStorage
    function loadHistory() {
      const savedHistory = localStorage.getItem('chatHistory');
      if (savedHistory) {
        history = JSON.parse(savedHistory);
        
        // Afficher les messages précédents
        history.forEach(item => {
          if (item.role === 'user') {
            appendMessage('user', `**Moi:** ${item.content}`);
          } else if (item.role === 'assistant') {
            appendMessage('bot', item.content);
          }
        });
      }
    }

    // Sauvegarder l'historique dans le localStorage
    function saveHistory() {
      localStorage.setItem('chatHistory', JSON.stringify(history));
    }

    // Nettoyer l'historique
    clearBtn.addEventListener('click', () => {
      if (confirm('Voulez-vous effacer l\'historique de conversation?')) {
        history = [];
        localStorage.removeItem('chatHistory');
        chatEl.innerHTML = '';
      }
    });

    // Indication de chargement
    let typingEl = null;
    function showTyping() {
      typingEl = document.createElement('div');
      typingEl.classList.add('message', 'bot', 'typing');
      typingEl.textContent = '...';
      chatEl.appendChild(typingEl);
      chatEl.scrollTop = chatEl.scrollHeight;
    }
    function hideTyping() {
      if (typingEl) chatEl.removeChild(typingEl);
      typingEl = null;
    }

    function appendMessage(who, text) {
      const div = document.createElement('div');
      div.classList.add('message', who);
      
      // Personnalisation du rendu Markdown pour les blocs de code
      const renderer = new marked.Renderer();
      renderer.code = function(code, language) {
        return `<div class="code-block">
                  <pre><code class="language-${language}">${code}</code></pre>
                  <button class="copy-btn">Copier</button>
                </div>`;
      };
      
      marked.setOptions({ renderer });
      div.innerHTML = marked.parse(text);
      
      // Ajouter les écouteurs d'événements pour les boutons de copie
      const copyButtons = div.querySelectorAll('.copy-btn');
      copyButtons.forEach(btn => {
        btn.addEventListener('click', function() {
          const codeBlock = this.previousElementSibling.querySelector('code');
          const textToCopy = codeBlock.textContent;
          
          navigator.clipboard.writeText(textToCopy)
            .then(() => {
              const originalText = this.textContent;
              this.textContent = 'Copié !';
              setTimeout(() => {
                this.textContent = originalText;
              }, 2000);
            })
            .catch(err => {
              console.error('Erreur de copie: ', err);
            });
        });
      });
      
      chatEl.appendChild(div);
      chatEl.scrollTop = chatEl.scrollHeight;
    }

    // Ajouter une image au chat
    function appendImage(who, imageData) {
      const div = document.createElement('div');
      div.classList.add('message', who);
      
      const img = document.createElement('img');
      img.src = imageData;
      img.classList.add('chat-image');
      img.alt = 'Image partagée';
      
      div.appendChild(img);
      chatEl.appendChild(div);
      chatEl.scrollTop = chatEl.scrollHeight;
    }

    async function send() {
      const message = inputEl.value.trim();
      
      // Si ni message ni image, ne rien faire
      if (!message && !currentImageData) return;
      
      if (message) {
        appendMessage('user', `**Moi:** ${message}`);
      }
      
      if (currentImageData) {
        appendImage('user', currentImageData);
      }
      
      inputEl.value = '';
      
      // Effacer l'aperçu de l'image
      if (currentImageData) {
        imagePreviewEl.style.display = 'none';
        currentImageData = null;
      }
      
      // Ne pas envoyer au serveur si uniquement une image
      if (!message) return;
      
      showTyping();
      try {
        const res = await fetch('/api/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ message, history })
        });
        const { reply } = await res.json();
        hideTyping();
        appendMessage('bot', reply);
        
        // Mettre à jour l'historique
        history.push({ role: 'user', content: message });
        history.push({ role: 'assistant', content: reply });
        
        // Sauvegarder l'historique
        saveHistory();
      } catch (err) {
        hideTyping();
        appendMessage('bot', 'Erreur de connexion au serveur');
      }
    }

    // Entrée pour envoyer, Maj+Entrée pour nouvelle ligne
    inputEl.addEventListener('keydown', e => {
      if (e.key === 'Enter') {
        if (e.shiftKey) {
          // Laisser le comportement par défaut pour Maj+Entrée (saut de ligne)
        } else {
          // Envoyer le message avec Entrée
          e.preventDefault();
          send();
        }
      }
    });
    
    // Gérer le collage dans la zone de texte
    document.addEventListener('paste', e => {
      const items = (e.clipboardData || e.originalEvent.clipboardData).items;
      
      for (const item of items) {
        if (item.type.startsWith('image')) {
          const blob = item.getAsFile();
          const reader = new FileReader();
          
          reader.onload = function(event) {
            // Récupérer les données de l'image
            currentImageData = event.target.result;
            
            // Afficher l'aperçu de l'image
            previewImgEl.src = currentImageData;
            imagePreviewEl.style.display = 'block';
          };
          
          reader.readAsDataURL(blob);
          break;
        }
      }
    });
    
    // Supprimer l'image en cours
    removeImgBtn.addEventListener('click', () => {
      imagePreviewEl.style.display = 'none';
      currentImageData = null;
    });
    
    sendBtn.addEventListener('click', send);
    
    // Toggle pour l'affichage de l'arborescence
    showTreeBtn.addEventListener('click', async () => {
      if (treeVisible) {
        fileTreeEl.style.display = 'none';
        showTreeBtn.textContent = 'Afficher arbre';
        showTreeBtn.classList.remove('active');
        treeVisible = false;
      } else {
        showTreeBtn.textContent = 'Masquer arbre';
        showTreeBtn.classList.add('active');
        try {
          const res = await fetch('/api/file-tree');
          const tree = await res.json();
          fileTreeEl.textContent = JSON.stringify(tree, null, 2);
          fileTreeEl.style.display = 'block';
          treeVisible = true;
        } catch {
          fileTreeEl.textContent = 'Erreur récupération arborescence';
          fileTreeEl.style.display = 'block';
          treeVisible = true;
        }
      }
    });

    // Charger l'historique au chargement de la page
    window.addEventListener('DOMContentLoaded', loadHistory);
  </script>
</body>
</html>