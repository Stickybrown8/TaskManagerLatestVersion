<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Chat GPT-4.1 RAG</title>
  <style>
    body { font-family: Arial, sans-serif; background: #f7f7f7; display: flex; flex-direction: column; align-items: center; margin: 0; padding: 1rem; height: 100vh; box-sizing: border-box; }
    h1   { margin: 0 0 1rem; color: #333; }
    #chat { background: #fff; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); padding: 1rem; width: 100%; max-width: 600px; flex: 1; overflow-y: auto; margin-bottom: 1rem; box-sizing: border-box; }
    .message { margin: 0.5rem 0; padding: 0.75rem; border-radius: 12px; line-height: 1.4; max-width: 80%; word-wrap: break-word; }
    .user    { background: #007bff; color: #fff; align-self: flex-end; }
    .bot     { background: #e9ecef; color: #333; align-self: flex-start; }
    .typing  { font-style: italic; opacity: 0.7; }
    #controls { display: flex; width: 100%; max-width: 600px; gap: 0.5rem; box-sizing: border-box; }
    #input   { flex: 1; padding: 0.75rem; border-radius: 8px; border: 1px solid #ccc; font-size: 1rem; box-sizing: border-box; }
    button   { padding: 0.75rem 1rem; border: none; border-radius: 8px; background: #28a745; color: #fff; font-size: 1rem; cursor: pointer; transition: background 0.2s; }
    button:hover { background: #218838; }
    pre      { background: #f1f1f1; border-radius: 8px; padding: 1rem; overflow-x: auto; font-family: monospace; margin-top: 1rem; white-space: pre-wrap; }
    code     { background: #eee; padding: 2px 4px; border-radius: 4px; }
    h3       { margin-top: 1rem; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>
<body>
  <h1>Chat GPT-4.1 RAG</h1>
  <div id="chat"></div>
  <div id="controls">
    <input id="input" placeholder="Écris ton message..." autocomplete="off" />
    <button id="send">Envoyer</button>
    <button id="show-tree">Afficher arbre</button>
  </div>
  <pre id="file-tree" style="display:none"></pre>
  <script>
    const chatEl = document.getElementById('chat');
    const inputEl = document.getElementById('input');
    const sendBtn = document.getElementById('send');
    const showTreeBtn = document.getElementById('show-tree');
    const fileTreeEl = document.getElementById('file-tree');
    let history = [];

    // Ajoute un indicateur de saisie
    let typingEl = null;
    function showTyping() {
      typingEl = document.createElement('div');
      typingEl.classList.add('message', 'bot', 'typing');
      typingEl.textContent = '...' ;
      chatEl.appendChild(typingEl);
      chatEl.scrollTop = chatEl.scrollHeight;
    }
    function hideTyping() {
      if (typingEl) {
        chatEl.removeChild(typingEl);
        typingEl = null;
      }
    }

    function appendMessage(who, text) {
      const div = document.createElement('div');
      div.classList.add('message', who);
      // Convertit markdown en HTML
      div.innerHTML = marked.parse(text);
      chatEl.appendChild(div);
      chatEl.scrollTop = chatEl.scrollHeight;
    }

    async function send() {
      const message = inputEl.value.trim();
      if (!message) return;
      appendMessage('user', `**Moi:** ${message}`);
      inputEl.value = '';
      showTyping();

      try {
        const res = await fetch('/api/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ message, history })
        });
        const { reply } = await res.json();
        hideTyping();
        appendMessage('bot', reply);
        history.push({ role: 'user', content: message });
        history.push({ role: 'assistant', content: reply });
      } catch (err) {
        hideTyping();
        appendMessage('bot', 'Erreur de connexion au serveur');
      }
    }

    async function showTree() {
      try {
        const res = await fetch('/api/file-tree');
        const tree = await res.json();
        fileTreeEl.textContent = JSON.stringify(tree, null, 2);
        fileTreeEl.style.display = 'block';
      } catch (err) {
        fileTreeEl.textContent = 'Erreur récupération arborescence';
        fileTreeEl.style.display = 'block';
      }
    }

    sendBtn.addEventListener('click', send);
    inputEl.addEventListener('keydown', e => e.key === 'Enter' && send());
    showTreeBtn.addEventListener('click', showTree);
  </script>
</body>
</html>
